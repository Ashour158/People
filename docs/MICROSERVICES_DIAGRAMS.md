# Microservices Architecture Diagram

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Client Applications                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  Web Browser │  │ Mobile App   │  │  Admin App   │  │  Third Party │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
└─────────┼──────────────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │                  │
          └──────────────────┴──────────────────┴──────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          API Gateway (Kong)                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ • Authentication (JWT)      • Rate Limiting      • Load Balancing    │   │
│  │ • Request Routing           • CORS               • Monitoring        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
          │
          ├─────────────┬─────────────┬─────────────┬─────────────┬─────────────┐
          │             │             │             │             │             │
          ▼             ▼             ▼             ▼             ▼             ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│   Auth       │ │   Employee   │ │  Attendance  │ │    Leave     │ │   Payroll    │
│   Service    │ │   Service    │ │   Service    │ │   Service    │ │   Service    │
│              │ │              │ │              │ │              │ │              │
│  Port 3001   │ │  Port 3002   │ │  Port 3003   │ │  Port 3004   │ │  Port 3005   │
└──────┬───────┘ └──────┬───────┘ └──────┬───────┘ └──────┬───────┘ └──────┬───────┘
       │                │                │                │                │
       │                └────────────────┴────────────────┴────────────────┘
       │                                 │
       │                                 ▼
       │                    ┌──────────────────────────────┐
       │                    │  Message Queue (RabbitMQ)    │
       │                    │  ┌────────────────────────┐  │
       │                    │  │  Exchange: hr.events   │  │
       │                    │  │  - employee.*          │  │
       │                    │  │  - leave.*             │  │
       │                    │  │  - attendance.*        │  │
       │                    │  │  - payroll.*           │  │
       │                    │  └────────────────────────┘  │
       │                    └──────────────────────────────┘
       │                                 │
       │                                 ├─────────────┬─────────────┐
       │                                 ▼             ▼             ▼
       │                    ┌──────────────────┐ ┌──────────────┐ ┌──────────────┐
       │                    │  Notification    │ │ Performance  │ │ Recruitment  │
       │                    │    Service       │ │   Service    │ │   Service    │
       │                    │                  │ │              │ │              │
       │                    │   Port 3006      │ │  Port 3007   │ │  Port 3008   │
       │                    └──────────────────┘ └──────────────┘ └──────────────┘
       │
       ├──────────────────────────────────────────────────────────────────────────┐
       │                                                                          │
       ▼                                                                          ▼
┌──────────────────────────────────────┐              ┌──────────────────────────┐
│  Service Discovery (Consul)          │              │   Databases              │
│  ┌────────────────────────────────┐  │              │  ┌────────────────────┐ │
│  │ • Service Registration         │  │              │  │  PostgreSQL        │ │
│  │ • Health Checks                │  │              │  │  ┌──────────────┐  │ │
│  │ • Configuration Management     │  │              │  │  │ auth_db      │  │ │
│  │ • Load Balancing               │  │              │  │  │ employee_db  │  │ │
│  └────────────────────────────────┘  │              │  │  │ attendance_db│  │ │
└──────────────────────────────────────┘              │  │  │ leave_db     │  │ │
                                                      │  │  │ payroll_db   │  │ │
┌──────────────────────────────────────┐              │  │  │ ...          │  │ │
│  Cache (Redis)                       │              │  │  └──────────────┘  │ │
│  ┌────────────────────────────────┐  │              │  │                    │ │
│  │ • Session Storage              │  │              │  │  Database Per      │ │
│  │ • Data Caching                 │  │              │  │  Service Pattern   │ │
│  │ • Rate Limiting                │  │              │  │                    │ │
│  └────────────────────────────────┘  │              │  └────────────────────┘ │
└──────────────────────────────────────┘              └──────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    Monitoring & Observability Stack                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │  Prometheus  │  │   Grafana    │  │    Jaeger    │  │  ELK Stack   │   │
│  │  (Metrics)   │  │ (Dashboards) │  │  (Tracing)   │  │  (Logging)   │   │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Event Flow Diagram

```
┌───────────────────────────────────────────────────────────────────────────┐
│                         Event-Driven Communication                         │
└───────────────────────────────────────────────────────────────────────────┘

1. Service creates/updates entity
   ┌──────────────┐
   │  Employee    │
   │  Service     │──┐
   └──────────────┘  │
                     │ 1. Save entity + event
                     ▼    in single transaction
              ┌─────────────────┐
              │   Database      │
              │  ┌───────────┐  │
              │  │ employees │  │
              │  └───────────┘  │
              │  ┌───────────┐  │
              │  │event_outbox│ Event stored
              │  └───────────┘  │
              └─────────────────┘
                     │
                     │ 2. Event Dispatcher polls
                     ▼    every 5 seconds
              ┌─────────────────┐
              │Event Dispatcher │
              │  (Background)   │
              └─────────────────┘
                     │
                     │ 3. Publish to RabbitMQ
                     ▼
              ┌─────────────────┐
              │   RabbitMQ      │
              │ Exchange        │
              │  hr.events      │
              │                 │
              │  Routing:       │
              │  employee.*     │
              └─────────────────┘
                     │
        ┌────────────┼────────────┐
        │            │            │
        ▼            ▼            ▼
  ┌──────────┐ ┌──────────┐ ┌──────────┐
  │ Queue:   │ │ Queue:   │ │ Queue:   │
  │ notif.   │ │ payroll. │ │ perf.    │
  │ employee │ │ employee │ │ employee │
  └──────────┘ └──────────┘ └──────────┘
        │            │            │
        │            │            │ 4. Services consume events
        ▼            ▼            ▼
  ┌──────────┐ ┌──────────┐ ┌──────────┐
  │Notif.    │ │Payroll   │ │Perform.  │
  │Service   │ │Service   │ │Service   │
  │          │ │          │ │          │
  │Send      │ │Setup     │ │Init      │
  │Email     │ │Salary    │ │Goals     │
  └──────────┘ └──────────┘ └──────────┘
```

## Request Flow - Example: Employee Creation

```
┌────────┐                                                          ┌────────┐
│ Client │                                                          │  DB    │
└───┬────┘                                                          └────────┘
    │
    │ 1. POST /api/v1/employees
    ├─────────────────────────────────────────────────────┐
    │                                                      ▼
    │                                           ┌──────────────────┐
    │                                           │  API Gateway     │
    │                                           │  (Kong)          │
    │                                           │  • Validate JWT  │
    │                                           │  • Rate Limit    │
    │                                           │  • Route Request │
    │                                           └────────┬─────────┘
    │                                                    │
    │                                                    │ 2. Forward to Employee Service
    │                                                    ▼
    │                                           ┌──────────────────┐
    │                                           │ Employee Service │
    │                                           │  Port 3002       │
    │                                           └────────┬─────────┘
    │                                                    │
    │                                                    │ 3. Validate input
    │                                                    │ 4. Start transaction
    │                                                    ▼
    │                                           ┌──────────────────┐
    │                                           │   PostgreSQL     │────┐
    │                                           │   employee_db    │    │
    │                                           └────────┬─────────┘    │
    │                                                    │              │
    │                                                    │ 5. Insert employee
    │                                                    │ 6. Insert event_outbox
    │                                                    │              │
    │                                                    ├──────────────┘
    │                                                    │ 7. Commit transaction
    │                                                    ▼
    │                                           ┌──────────────────┐
    │ 8. Return success                         │  Response        │
    │◄──────────────────────────────────────────┤  201 Created     │
    │                                           └──────────────────┘
    │
    │                           (Asynchronously, within 5 seconds)
    │
    │                                           ┌──────────────────┐
    │                                           │ Event Dispatcher │
    │                                           │  (Polling)       │
    │                                           └────────┬─────────┘
    │                                                    │
    │                                                    │ 9. Poll event_outbox
    │                                                    │ 10. Read pending events
    │                                                    ▼
    │                                           ┌──────────────────┐
    │                                           │   RabbitMQ       │
    │                                           │   Exchange       │
    │                                           └────────┬─────────┘
    │                                                    │
    │                                                    │ 11. Publish event
    │                                                    │     employee.created
    │                              ┌─────────────────────┼─────────────────────┐
    │                              │                     │                     │
    │                              ▼                     ▼                     ▼
    │                     ┌────────────────┐   ┌────────────────┐   ┌────────────────┐
    │                     │ Notification   │   │ Payroll        │   │ Performance    │
    │                     │ Service        │   │ Service        │   │ Service        │
    │                     │                │   │                │   │                │
    │                     │ 12. Send       │   │ 12. Create     │   │ 12. Init       │
    │                     │     Welcome    │   │     Salary     │   │     Goals      │
    │                     │     Email      │   │     Structure  │   │     Template   │
    │                     └────────────────┘   └────────────────┘   └────────────────┘
    │
    ▼
```

## Deployment Architecture

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          Kubernetes Cluster                                   │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                        Namespace: hr-system                         │    │
│  │                                                                      │    │
│  │  ┌──────────────────────┐      ┌──────────────────────┐            │    │
│  │  │  Ingress Controller  │      │   API Gateway (Kong) │            │    │
│  │  │  (External Access)   │─────▶│   (Internal Routing) │            │    │
│  │  └──────────────────────┘      └──────────────────────┘            │    │
│  │                                            │                         │    │
│  │           ┌────────────────────────────────┼──────────────┐         │    │
│  │           │              │                 │              │         │    │
│  │           ▼              ▼                 ▼              ▼         │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │    │
│  │  │Auth Service │ │Employee Svc │ │Attend. Svc  │ │Leave Service│  │    │
│  │  │             │ │             │ │             │ │             │  │    │
│  │  │ Deployment  │ │ Deployment  │ │ Deployment  │ │ Deployment  │  │    │
│  │  │ Replicas: 3 │ │ Replicas: 3 │ │ Replicas: 3 │ │ Replicas: 3 │  │    │
│  │  │ HPA: 2-10   │ │ HPA: 2-10   │ │ HPA: 2-10   │ │ HPA: 2-10   │  │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │    │
│  │                                                                      │    │
│  │  ┌──────────────────────────────────────────────────────────┐       │    │
│  │  │  Shared Infrastructure                                   │       │    │
│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐           │       │    │
│  │  │  │PostgreSQL  │ │ RabbitMQ   │ │   Redis    │           │       │    │
│  │  │  │StatefulSet │ │StatefulSet │ │StatefulSet │           │       │    │
│  │  │  └────────────┘ └────────────┘ └────────────┘           │       │    │
│  │  │  ┌────────────┐ ┌────────────┐ ┌────────────┐           │       │    │
│  │  │  │ Prometheus │ │  Grafana   │ │   Jaeger   │           │       │    │
│  │  │  │ Deployment │ │ Deployment │ │ Deployment │           │       │    │
│  │  │  └────────────┘ └────────────┘ └────────────┘           │       │    │
│  │  └──────────────────────────────────────────────────────────┘       │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────┘
```

## Service Communication Patterns

### Synchronous (REST API)
```
Service A ──HTTP──▶ Service B
          ◀────────
         Response
```

Use for:
- Query operations
- Immediate response needed
- When consistency is critical

### Asynchronous (Message Queue)
```
Service A ──Event──▶ RabbitMQ ──Event──▶ Service B
                         │
                         ├──Event──▶ Service C
                         │
                         └──Event──▶ Service D
```

Use for:
- Event notifications
- Long-running operations
- Eventual consistency
- Decoupled processing

## Data Flow Pattern (CQRS)

```
┌─────────────────────────────────────────────────────────────┐
│                       Write Side                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Client ──▶ API ──▶ Command ──▶ Service ──▶ Write DB       │
│                                      │                      │
│                                      ▼                      │
│                                   Events                    │
│                                      │                      │
└──────────────────────────────────────┼──────────────────────┘
                                       │
                                       ▼
                                ┌──────────────┐
                                │  RabbitMQ    │
                                └──────┬───────┘
                                       │
┌──────────────────────────────────────┼──────────────────────┐
│                       Read Side      │                      │
├──────────────────────────────────────┼──────────────────────┤
│                                      ▼                      │
│  Client ◀── API ◀── Query ◀── Read DB (Denormalized)       │
│                                      ▲                      │
│                                      │                      │
│                                Event Handler                │
│                             (Updates read models)           │
└─────────────────────────────────────────────────────────────┘
```

## Scaling Strategy

```
┌────────────────────────────────────────────────────────────────┐
│                    Load Distribution                            │
└────────────────────────────────────────────────────────────────┘

              Load Balancer (Kubernetes Service)
                            │
              ┌─────────────┼─────────────┐
              │             │             │
              ▼             ▼             ▼
        ┌─────────┐   ┌─────────┐   ┌─────────┐
        │  Pod 1  │   │  Pod 2  │   │  Pod 3  │   ◀─ Min Replicas: 2
        └─────────┘   └─────────┘   └─────────┘

        When CPU > 70% or Memory > 80%:
              ▼             ▼             ▼
        ┌─────────┐   ┌─────────┐   ┌─────────┐
        │  Pod 4  │   │  Pod 5  │   │  Pod 6  │   ◀─ Scales up
        └─────────┘   └─────────┘   └─────────┘

        Up to Max Replicas: 10
```

## Migration Phases Visual

```
┌──────────────────────────────────────────────────────────────────────────┐
│ Phase 1: Monolith + Message Queue                                       │
├──────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐                ┌──────────────┐                       │
│  │   Monolith   │───Events──────▶│  RabbitMQ    │                       │
│  │  (All Logic) │                └──────────────┘                       │
│  └──────────────┘                                                        │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ Phase 2: Extract Notification Service                                   │
├──────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐                ┌──────────────┐     ┌─────────────┐  │
│  │   Monolith   │───Events──────▶│  RabbitMQ    │────▶│Notification │  │
│  │ (Most Logic) │                └──────────────┘     │  Service    │  │
│  └──────────────┘                                     └─────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ Phase 3: Extract Core Services                                          │
├──────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐                ┌──────────────┐     ┌─────────────┐  │
│  │   Monolith   │───Events──────▶│  RabbitMQ    │────▶│   Auth      │  │
│  │(Some Logic)  │                └──────┬───────┘     └─────────────┘  │
│  └──────────────┘                       │             ┌─────────────┐  │
│                                          ├────────────▶│  Employee   │  │
│                                          │             └─────────────┘  │
│                                          │             ┌─────────────┐  │
│                                          └────────────▶│ Attendance  │  │
│                                                        └─────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ Phase 4: API Gateway + All Services                                     │
├──────────────────────────────────────────────────────────────────────────┤
│        ┌──────────────┐                                                  │
│        │ API Gateway  │                                                  │
│        └──────┬───────┘                                                  │
│    ┌──────────┼──────────┬──────────┬──────────┐                        │
│    ▼          ▼          ▼          ▼          ▼                        │
│  ┌────┐   ┌────┐   ┌────┐   ┌────┐   ┌────┐                            │
│  │Auth│   │Emp │   │Att │   │Leav│   │Pay │   All Services              │
│  └────┘   └────┘   └────┘   └────┘   └────┘                            │
│                     │                                                     │
│                     └──────▶ RabbitMQ ◀──────┐                          │
│                              (Events)         │                          │
│                                   ▼           ▼                          │
│                             ┌─────────┐ ┌─────────┐                     │
│                             │ Notif.  │ │ Perf.   │                     │
│                             └─────────┘ └─────────┘                     │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│ Phase 5: Monolith Decommissioned                                        │
├──────────────────────────────────────────────────────────────────────────┤
│        ┌──────────────┐                                                  │
│        │ API Gateway  │                                                  │
│        └──────┬───────┘                                                  │
│    ┌──────────┼──────────┬──────────┬──────────┬──────────┐             │
│    ▼          ▼          ▼          ▼          ▼          ▼             │
│  ┌────┐   ┌────┐   ┌────┐   ┌────┐   ┌────┐   ┌────┐                  │
│  │Auth│   │Emp │   │Att │   │Leav│   │Pay │   │Rec │   Pure            │
│  └────┘   └────┘   └────┘   └────┘   └────┘   └────┘   Microservices  │
│             │                                      │                      │
│             └──────▶ RabbitMQ ◀──────────────────┘                      │
│                      (Events)                                            │
│                         ▼                                                 │
│                    ┌─────────┐ ┌─────────┐ ┌─────────┐                 │
│                    │ Notif.  │ │ Perf.   │ │ Train.  │                 │
│                    └─────────┘ └─────────┘ └─────────┘                 │
└──────────────────────────────────────────────────────────────────────────┘
```

---

**Legend**:
- ──▶ : Synchronous request/response
- ──Event──▶ : Asynchronous event publishing
- ├─ : Branching connection
- └─ : Terminal connection
